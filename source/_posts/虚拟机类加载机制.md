title: 虚拟机类加载机制
date: 2014-04-05 16:23:04
tags: Java
---

类从被加载到虚拟机内存中开始到从内存中卸载，主要的生命周期有：加载、验证、准备、解析、初始化、使用和卸载这七个阶段。

##### 加载时机
- 加载 
    Java虚拟机没有进行强制约束，可由具体实现自己把握
- 初始化
    Java虚拟机严格规定了有且只有五种情形必须立即对类进行初始化:
        (1)遇到new,getstatic,putstatic,invokestatic这４条指令时，如果类没有进行初始化则进行初始化
        (2)使用reflect包进行反射调用时，如果类没有初始化则进行初始化
        (3)如果类初始化时发现父类还没有过初始化，则需要先触发父类初始化
        (4)虚拟机启动时，用户制定一个要执行的类，虚拟机先初始化这个主类
        (5)当使用JDK1.7动态语言支持时，如果一个java.lang.invoke.MethodHandle实例最后的解析结果REF_getStatic,REF_putStatic,REF_invokeStatic方法句柄，并且这个方法句柄所对应的类没有进行过初始化，则需要先触发其初始化。
    这5种行为称为对一个类进行主动引用，其余称为被动引用。被动引用不会引发类的初始化。
------------

#####加载过程
------------
- 加载
加载主要完成下面３件事:
        (1)通过类的全限定名来获取定义此类的二进制字节流
        (2)将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构
        (3)在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口
- 验证
这一阶段的目的是确保Class文件的字节流中包含的信息符合虚拟机的要求,不会危害虚拟机的安全
        (1)文件格式验证:0xCAFEBABE，主次版本号是否在虚拟机处理范围内...
        (2)元数据验证:这个类是否有父类，这个类是否继承了不允许继承的类...
        (3)字节码验证：通过数据流和控制流分析，确定程序语义是合法的，符合逻辑的
        (4)符号引用验证
- 准备
为类变量分配内存并设置类变量初始值的阶段
- 解析
虚拟机将常量池内符号引用替换为直接引用的过程
        (1)类或接口的解析
        (2)字段解析
        (3)类方法解析
        (4)接口方法解析
- 初始化
前面类加载过程中，除了在加载阶段用户应用程序可以通过自定义类加载器参与之外，其余动作完全由虚拟机主导和控制。到了初始化阶段，才真正开始执行类中定义的Java程序代码
